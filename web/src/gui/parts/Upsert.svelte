<!-- @hmr:keep-all -->
<script context="module" lang="ts">
  import { onDestroy } from 'svelte'
  import { writable } from 'svelte/store'

  import { vdict, ztext, zfrom, zupto } from '$lib/stores'
  import { upsert_dicts } from '$utils/vpdict_utils'
  import { api_call } from '$lib/api_call'

  import { related_words, VpForm } from './Upsert/_shared'

  import pt_labels from '$lib/consts/postag_labels.json'

  export const ctrl = {
    ...writable({ tab: 0, state: 0 }),
    show: (tab = 0, state = 1, from?: number, upto?: number) => {
      if (from) zfrom.set(from)
      if (upto) zupto.set(upto)
      ctrl.set({ tab, state })
    },
    hide: () => ctrl.set_state(0),
    set_tab: (tab: number) => ctrl.update((x) => ({ ...x, tab })),
    set_state: (state: number) => ctrl.update((x) => ({ ...x, state })),
  }

  // const tabs = [
  //   { kbd: 'x', icon: 'book', class: 'novel' },
  //   { kbd: 'c', icon: 'world', class: 'basic' },
  //   { kbd: 'v', icon: 'package', class: 'miscs' },
  // ]

  interface JsonData {
    pin_yin: string
    hanviet: string

    current?: CV.VpTerm

    tag_hints: string[]
    val_hints: string[]
  }
</script>

<script lang="ts">
  import { ctrl as tlspec } from '$gui/parts/Tlspec.svelte'

  import SIcon from '$gui/atoms/SIcon.svelte'
  import Gmenu from '$gui/molds/Gmenu.svelte'
  import Dialog from '$gui/molds/Dialog.svelte'

  import Postag from './Postag.svelte'

  import Hanzi from './Upsert/Hanzi.svelte'

  import Emend from './Upsert/Emend.svelte'
  import SegRank from './Upsert/SegRank.svelte'
  import Vutil from './Upsert/Vutil.svelte'

  import Footer from './Upsert/Footer.svelte'
  import TranHint from './Upsert/TranHint.svelte'

  export let on_change = () => {}
  export let on_destroy = () => {}

  onDestroy(on_destroy)

  let data: JsonData = {
    pin_yin: '',
    hanviet: '',
    current: null,
    val_hints: [],
    tag_hints: [],
  }

  let key = $ztext.substring($zfrom, $zupto)
  let form = VpForm.from(key)

  $: dicts = upsert_dicts($vdict)
  $: update_data($ztext, $zfrom, $zupto)

  let cached: Record<string, JsonData> = {}

  async function update_data(ztext: string, zfrom: number, zupto: number) {
    const words = related_words(ztext, zfrom, zupto)

    const body = words.filter((w) => !cached[w]).slice(0, 5)

    if (body.length > 0) {
      const api = `/_m1/terms/query?vd_id=${$vdict.vd_id}`
      const res: Record<string, JsonData> = await api_call(api, body, 'POST')
      for (const [key, data] of Object.entries(res)) cached[key] = data
    }

    data = cached[words[0]]
    form = new VpForm(
      data.current || { key, dic: $vdict.vd_id },
      data.val_hints,
      data.tag_hints,
      $vdict.vd_id
    )
  }

  let field: HTMLInputElement
  const refocus = () => field && field.focus()

  $: if (form) {
    refocus()
  }

  $: [lbl_state, btn_state] = form.state

  const copy_raw = () => navigator.clipboard.writeText(key)

  const submit_val = async () => {
    const res = await fetch('/_m1/defns', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: form.toJSON($ztext, $zfrom),
    })

    if (!res.ok) {
      console.log(await res.text())
    } else {
      on_change()
    }
  }
</script>

<Dialog
  actived={$ctrl.state > 0}
  on_close={ctrl.hide}
  class="upsert"
  _size="lg">
  <upsert-head class="head">
    <Gmenu dir="left" loc="bottom">
      <button class="m-btn _text" slot="trigger">
        <SIcon name="menu-2" />
      </button>
      <svelte:fragment slot="content">
        <a
          class="gmenu-item"
          href="/dicts/{$vdict.dslug}"
          target="_blank"
          rel="noreferrer">
          <SIcon name="package" />
          <span>Từ điển</span>
        </a>

        <button class="gmenu-item" on:click={tlspec.show}>
          <SIcon name="flag" />
          <span>Báo lỗi</span>
        </button>

        <button class="gmenu-item" data-kbd="⌃c" on:click={copy_raw}>
          <SIcon name="copy" />
          <span>Copy text</span>
        </button>
      </svelte:fragment>
    </Gmenu>

    <Hanzi pinyin={data.pin_yin} bind:output={key} />

    <button
      type="button"
      class="m-btn _text"
      data-kbd="esc"
      on:click={ctrl.hide}>
      <SIcon name="x" />
    </button>
  </upsert-head>

  <upsert-tabs>
    <button
      class="tab-item _miscs"
      class:_active={$ctrl.tab == 0}
      data-kbd="x"
      on:click={() => ctrl.set_tab(0)}>
      <SIcon name="package" />
      <span>Thêm sửa từ</span>
    </button>

    <button
      class="tab-item _basic"
      class:_active={$ctrl.tab == 1}
      data-kbd="c"
      on:click={() => ctrl.set_tab(1)}>
      <SIcon name="history" />
      <span>Lịch sử thêm sửa</span>
    </button>

    <button
      class="tab-item _novel"
      class:_active={$ctrl.tab == 2}
      data-kbd="c"
      on:click={() => ctrl.set_tab(2)}>
      <SIcon name="message" />
      <span>Tranh luận</span>
    </button>
  </upsert-tabs>

  <main class="upsert-body">
    {#if $ctrl.tab == 0}
      <Emend {form} {dicts} />

      <upsert-main>
        <TranHint hanviet={data.hanviet} val_hints={data.val_hints} bind:form />
        <div class="value" class:_fresh={form.init.state == 'Xoá'}>
          <input
            type="text"
            class="-input"
            bind:this={field}
            bind:value={form.val}
            autocomplete="off"
            autocapitalize="off" />

          <button class="ptag" data-kbd="w" on:click={() => ctrl.set_state(2)}>
            {pt_labels[form.ptag] || 'Phân loại'}
          </button>
        </div>

        <Vutil bind:form />
      </upsert-main>

      <upsert-foot>
        <SegRank bind:form />

        <btn-group>
          <button
            class="m-btn _lg _fill {btn_state}"
            data-kbd="↵"
            disabled={!form.changed()}
            on:click={submit_val}>
            <span class="submit-text">{lbl_state}</span>
          </button>
        </btn-group>
      </upsert-foot>
    {:else}
      <div class="empty">Đợi thêm sau</div>
    {/if}
  </main>

  <Footer {key} />
</Dialog>

{#if $ctrl.state == 2}
  <Postag bind:ptag={form.ptag} bind:state={$ctrl.state} />
{/if}

<style lang="scss">
  $gutter: 0.75rem;

  upsert-head {
    @include flex();

    @include border(--bd-soft, $loc: bottom);

    .m-btn {
      @include fgcolor(neutral, 5);
      background: none;
      --linesd: none;

      &:hover {
        @include fgcolor(primary, 5);
      }
    }
  }

  $tab-height: 2rem;

  upsert-tabs {
    margin-top: 0.5rem;
    height: $tab-height;
    padding: 0 0.75rem;

    gap: 0.5rem;
    @include flex;
    @include border(--bd-main, $loc: bottom);

    justify-content: center;
    font-size: rem(14px);

    // prettier-ignore
  }

  .tab-item {
    cursor: pointer;
    @include flex($center: vert);
    // text-transform: capitalize;
    padding: 0 0.375rem;
    flex-shrink: 0;
    height: $tab-height;
    line-height: $tab-height;
    font-weight: 500;
    background-color: transparent;

    @include bdradi($loc: top);
    @include fgcolor(tert);
    @include border(--bd-main, $loc: top-left-right);

    &._edited {
      @include fgcolor(secd);
    }

    &:hover {
      @include bgcolor(secd);
    }

    &._active {
      flex-shrink: 0;
      @include bgcolor(secd);
      @include fgcolor(primary, 5);
      @include bdcolor(primary, 5);
    }

    > span {
      display: block;
      @include clamp($width: 100%, $style: '-');
    }

    > :global(svg) {
      width: 1.25rem;
      margin-right: 0.125rem;
      @include bps(display, none, $pl: inline-block);
    }
  }

  .tab-btn {
    padding: 0 0.5rem;
    background-color: transparent;

    height: $tab-height;
    line-height: $tab-height;
    @include fgcolor(tert);
    &:hover {
      @include fgcolor(primary, 5);
    }
  }

  .upsert-body {
    display: block;
    padding: 0 0.75rem;
    @include bgcolor(bg-secd);
  }

  upsert-main {
    display: block;
    @include bdradi;

    @include linesd(--bd-main, $inset: true);
    @include bgcolor(main);

    &:focus-within {
      // @include linesd(primary, 4, $ndef: false);
      @include bgcolor(secd);
    }
  }

  .value {
    display: flex;
    $h-outer: 3.25rem;
    $h-inner: 1.75rem;

    height: $h-outer;
    padding: math.div($h-outer - $h-inner, 2);

    @include linesd(--bd-soft, $inset: true);

    &:focus-within {
      @include linesd(primary, 4, $ndef: false);
    }

    > * {
      height: $h-inner;
      // line-height: 1.75rem;
    }

    &._fresh > * {
      font-style: italic;
    }

    > .-input {
      flex: 1;
      min-width: 1rem;
      outline: 0;
      border: 0;
      background: transparent;
      @include fgcolor(main);
      @include ftsize(lg);
    }
  }

  .ptag {
    white-space: nowrap;
    padding: 0 0.5rem;
    margin-left: 0.5rem;
    background: transparent;
    border-radius: 0.75rem;
    font-weight: 500;

    @include fgcolor(tert);
    @include linesd(--bd-main);
    @include bps(font-size, rem(12px), rem(13px), rem(14px));

    &:hover {
      @include fgcolor(primary, 5);
    }
  }

  upsert-foot {
    display: flex;
    padding: 0.75rem 0;
    justify-content: right;
  }

  btn-group {
    @include flex();
    gap: 0.5rem;
  }

  .empty {
    height: 15rem;
    @include flex-ca;
  }
</style>
